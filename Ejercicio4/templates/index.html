<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador Baja California | MapVentura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #000; font-family: 'Inter', sans-serif; }
        #map { height: 100%; width: 100%; background: #0f172a; }
        .leaflet-tile { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3); }
        
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: #7c3aed !important;
            color: white !important;
            border: none !important;
            width: 44px !important;
            height: 44px !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        
        .poi-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
            border: 2px solid #7c3aed;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        .poi-icon:hover { transform: scale(1.2); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="h-16 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center space-x-2">
            <div class="bg-violet-600 p-1.5 rounded-lg">
                <i class="fas fa-map-marked-alt text-white"></i>
            </div>
            <span class="text-xl font-bold text-white tracking-tighter">MAP<span class="text-violet-500">VENTURA</span></span>
        </div>
        <div class="flex items-center space-x-4">
            <span class="text-[10px] text-gray-500 hidden sm:block uppercase tracking-widest">Explorando Baja California</span>
            <div id="loader" class="hidden"><i class="fas fa-circle-notch fa-spin text-violet-500"></i></div>
        </div>
    </nav>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        <!-- Area del Mapa -->
        <section class="relative w-full md:w-3/5 lg:w-2/3 h-1/2 md:h-full border-r border-gray-800">
            <div id="map"></div>
            
            <!-- Botón flotante para recargar área actual -->
            <button onclick="fetchNearbyPOIs()" class="absolute top-4 right-4 z-[1000] bg-violet-600 hover:bg-violet-700 text-white p-3 rounded-full shadow-lg transition-all active:scale-95" title="Buscar en esta zona">
                <i class="fas fa-sync-alt"></i>
            </button>

            <div id="toast">
                <div id="toast-content" class="bg-gray-900 text-white px-6 py-3 rounded-full font-bold shadow-2xl flex items-center space-x-2 border border-violet-500/50">
                    <i id="toast-icon" class="fas fa-info-circle text-violet-400"></i>
                    <span id="toast-text" class="text-sm text-gray-200">Buscando lugares...</span>
                </div>
            </div>
        </section>

        <!-- Area de Lista -->
        <aside class="w-full md:w-2/5 lg:w-1/3 bg-black flex flex-col h-1/2 md:h-full overflow-hidden">
            <div class="p-4 border-b border-gray-800 bg-gray-900/50 flex justify-between items-center text-white">
                <h2 class="font-bold text-sm uppercase tracking-tight">Lugares en tu Ruta</h2>
                <span id="count" class="bg-violet-600 px-2 py-0.5 rounded-full text-xs font-mono">0</span>
            </div>
            <div id="places-list" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="text-center py-10">
                    <i class="fas fa-ghost text-gray-800 text-4xl mb-4"></i>
                    <p class="text-gray-500 text-xs px-10">Mueve el mapa por el estado y presiona el icono de recarga o selecciona un lugar para guardarlo.</p>
                </div>
            </div>
        </aside>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Coordenadas iniciales (Tijuana)
        const initialCoords = [32.4575, -116.8256];
        const map = L.map('map', { zoomControl: false }).setView(initialCoords, 14);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const poiLayer = L.layerGroup().addTo(map);
        const markersMap = new Map();
        let isFetching = false;

        // Diccionario de iconos por categoría
        const categories = {
            'restaurant': { icon: 'fa-utensils', color: '#f59e0b' },
            'cafe': { icon: 'fa-coffee', color: '#a855f7' },
            'shop': { icon: 'fa-shopping-bag', color: '#10b981' },
            'pharmacy': { icon: 'fa-medkit', color: '#ef4444' },
            'park': { icon: 'fa-tree', color: '#22c55e' },
            'tourist': { icon: 'fa-camera', color: '#3b82f6' }
        };

        const getPoiIcon = (tags) => {
            let config = { icon: 'fa-map-marker-alt', color: '#7c3aed' };
            
            if (tags.amenity === 'restaurant' || tags.amenity === 'fast_food') config = categories.restaurant;
            else if (tags.amenity === 'cafe') config = categories.cafe;
            else if (tags.shop) config = categories.shop;
            else if (tags.amenity === 'pharmacy') config = categories.pharmacy;
            else if (tags.leisure === 'park') config = categories.park;
            else if (tags.tourism) config = categories.tourist;
            
            return L.divIcon({
                html: `<div class="poi-icon" style="width:32px; height:32px; border-color:${config.color};">
                        <i class="fas ${config.icon}" style="color:${config.color}; font-size:14px;"></i>
                       </div>`,
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
        };

        // Búsqueda dinámica con Overpass API
        async function fetchNearbyPOIs() {
            if (isFetching || map.getZoom() < 13) return; // No buscar si el zoom es muy lejano
            
            isFetching = true;
            document.getElementById('loader').classList.remove('hidden');
            showToast("Actualizando lugares de la zona...", "fa-sync fa-spin");

            const bounds = map.getBounds();
            // Query expandida para capturar más tipos de lugares en BC
            const query = `
                [out:json][timeout:25];
                (
                  node["amenity"~"restaurant|cafe|pharmacy|bank"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
                  node["shop"~"convenience|supermarket|mall"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
                  node["tourism"~"attraction|viewpoint|hotel"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
                  node["leisure"="park"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
                );
                out body 50; 
            `;
            
            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                poiLayer.clearLayers();
                data.elements.forEach(el => {
                    if (!el.lat || !el.lon) return;

                    const marker = L.marker([el.lat, el.lon], { icon: getPoiIcon(el.tags) }).addTo(poiLayer);
                    const name = el.tags.name || "Lugar sin nombre";
                    const info = el.tags.amenity || el.tags.shop || el.tags.tourism || "Punto de interés";

                    marker.bindPopup(`
                        <div class="text-center font-sans">
                            <b class="text-gray-900 block border-b pb-1 mb-1">${name}</b>
                            <span class="text-[9px] text-gray-400 uppercase tracking-tighter">${info}</span><br>
                            <button onclick="addSavedPoint('${name.replace(/'/g, "\\'")}', ${el.lat}, ${el.lon})" 
                                    class="mt-2 bg-violet-600 hover:bg-violet-700 text-white px-3 py-1 rounded-full text-[10px] font-bold transition-colors">
                                <i class="fas fa-plus mr-1"></i> Guardar
                            </button>
                        </div>
                    `);
                });
                
                showToast(`Se encontraron ${data.elements.length} lugares aquí`);
            } catch (e) {
                showToast("Error de conexión con el mapa", "fa-exclamation-circle");
            } finally {
                isFetching = false;
                document.getElementById('loader').classList.add('hidden');
            }
        }

        // Guardar lugar en la lista lateral
        window.addSavedPoint = function(name, lat, lng) {
            const id = Date.now();
            const list = document.getElementById('places-list');
            
            // Limpiar mensaje vacío
            if (markersMap.size === 0) list.innerHTML = '';
            
            const item = document.createElement('div');
            item.className = "bg-gray-900 p-4 rounded-xl border border-gray-800 flex justify-between items-center group hover:border-violet-500/50 transition-all cursor-pointer";
            item.innerHTML = `
                <div onclick="map.flyTo([${lat}, ${lng}], 17)">
                    <p class="text-white text-xs font-bold group-hover:text-violet-400">${name}</p>
                    <p class="text-gray-500 text-[9px] font-mono mt-1">${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
                </div>
                <button onclick="event.stopPropagation(); this.parentElement.remove(); updateCount(-1);" class="text-gray-700 hover:text-red-500 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            `;
            list.prepend(item);
            markersMap.set(id, { lat, lng });
            updateCount(1);
            showToast("Agregado a tu diario de ruta", "fa-bookmark");
        };

        function updateCount(val) {
            const badge = document.getElementById('count');
            badge.innerText = parseInt(badge.innerText) + val;
        }

        function showToast(text, icon = "fa-check") {
            const t = document.getElementById('toast');
            document.getElementById('toast-text').innerText = text;
            document.getElementById('toast-icon').className = `fas ${icon} text-violet-400`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // EVENTOS DE NAVEGACIÓN
        // 1. Al terminar de mover el mapa, busca nuevos lugares automáticamente
        map.on('moveend', fetchNearbyPOIs);

        // 2. Carga inicial
        window.onload = () => {
            // Marcador de la UTT
            L.marker(initialCoords, { 
                icon: L.divIcon({ 
                    html: '<div class="bg-violet-600 p-2 rounded-lg shadow-lg border-2 border-white"><i class="fas fa-university text-white text-sm"></i></div>', 
                    className: '', iconSize:[35,35], iconAnchor:[17,17] 
                }) 
            }).addTo(map).bindPopup("<b>UTT Tijuana</b><br>Punto de partida.");
            
            fetchNearbyPOIs();
        };
    </script>
</body>
</html>